
  <!--
    *
    * login buttons
    *
    ************************************
  -->

  <!-- not logged in -->
  <?php if ( !$this->member ): ?>

      <?php echo \Tbmt\view\Factory::buildInfoBox(
        $this->i18nView['want_purchase'],
        $this->i18nView['require_login'],
        \Tbmt\view\Factory::buildButton(
            $this->i18nView['signup_button'],
            \Tbmt\Router::toModule('member', 'signup'),
            'blue pull-right'
          ).
          \Tbmt\view\Factory::buildButton(
            $this->i18nView['login_button'],
            \Tbmt\Router::toModule('account'),
            'yellow pull-right right-10'
        ),
        ''
      ); ?>


  <!-- is logged in -->
  <?php else: ?>

    <!--
      *
      * handle the actual purchase things
      *
      ************************************
    -->
    <?php if ( $this->member && $this->member->isMarkedAsPaid() ): ?>

      <?php echo \Tbmt\view\Factory::buildInfoBox(
        $this->i18nView['purchased_already'],
        '<a href="'.\Tbmt\Router::toModule('account').'">'.$this->i18nView['purchased_already_link'].'</a>',
        '',
        ''
      ); ?>

    <?php elseif ( $this->member && !$this->member->isMarkedAsPaid() ): ?>

      <div class="row">

        <div class="col-sm-6 top-20" style="text-align: center;">
          <div id="paypal-button"></div>
        </div>
        <div class="col-sm-6 bottom-20" style="text-align: center;">
          <div><?=$this->i18nView['paypal_register_text']?></div>
          <a class="paypal-register-button" href="https://www.paypal.com" target="_blank"><?=$this->i18nView['paypal_register_button']?></a>
        </div>

      </div>

      <?php if ( $this->member->isExtended() ): ?>
        <?=\Tbmt\view\Factory::testimonial(
          \Tbmt\Localizer::insert($this->i18nView['extended_system_user_note'], [
            'url' => \Tbmt\Config::get('extended.system.url')
          ])
        )?>
      <?php endif; ?>

      <!-- Modal -->
      <div class="modal fade" id="purchase-success-dialog" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
            <div class="contact-modal">
              <div id="contact">
                <div class="bottom-20 text-center contact-modeal-heading">
                  <h3 class="white heading bottom-0"><?php echo $this->i18nView['popup_purchase_success_text']; ?></h3>
                </div>
                <br>
                <div class="text-center">
                  <i class="fa fa-check text-success" style="font-size: 38px;"></i><br>
                  You will be redirect after a view seconds
                </div>
                <br>
              </div><!-- // #contact -->
            </div><!-- // #contact-modal -->
          </div><!-- // .modal-content -->
        </div><!-- // .modal-dialog -->
      </div><!-- // .modal -->

      <!-- Modal -->
      <div class="modal fade" id="purchase-loading-dialog" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
            <div class="contact-modal">
              <div id="contact">
                <div class="bottom-20 text-center contact-modeal-heading">
                  <h3 class="white heading bottom-0"><?php echo $this->i18nView['popup_purchase_loading_text']; ?></h3>
                </div>
                <br>
                <div class="text-center">
                  <?=Tbmt\view\Factory::buildLoadingIndicator()?>
                </div>
                <br>
              </div><!-- // #contact -->
            </div><!-- // #contact-modal -->
          </div><!-- // .modal-content -->
        </div><!-- // .modal-dialog -->
      </div><!-- // .modal -->

      <!-- Modal -->
      <div class="modal fade" id="purchase-cancelation-dialog" tabindex="-1" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="contact-modal">

              <div id="contact">

                  <div class="bottom-20 text-center contact-modeal-heading">
                    <h3 class="white heading bottom-0"><?php echo $this->i18nView['popup_purchase_head']; ?></h3>
                  </div>

                  <h3 class="text-center"><?=$this->i18nView['popup_purchase_cancel_text']?></h3>

                  <p id="purchase-cancelation-errorinfo"></p>

                  <div class="contact-modeal-footer top-20">
                    <?=Tbmt\view\Factory::buildButtonTag($this->i18nView['popup_purchase_close'], 'black pull-right', 'times', ['data-dismiss' => 'modal'])?>
                    <div class="clearfix"></div>
                  </div><!-- // .contact-modeal-footer -->

              </div><!-- // #contact -->
            </div><!-- // #contact-modal -->
          </div><!-- // .modal-content -->
        </div><!-- // .modal-dialog -->
      </div><!-- // .modal -->

      <!-- Modal -->
      <div class="modal fade" id="purchase-confirmation-dialog" tabindex="-1" role="dialog" data-backdrop="static">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="contact-modal">

              <div id="contact">

                  <div class="bottom-20 text-center contact-modeal-heading">
                    <h3 class="white heading bottom-0"><?php echo $this->i18nView['popup_purchase_head']; ?></h3>
                  </div><!-- // .contact-modeal-heading -->

                  <p><?=$this->i18nView['popup_purchase_text1']?></p>

                  <h3><?=$this->i18nView['popup_purchase_text2']?></h3>
                  <ul>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text3'],
                      $this->i18nView['popup_purchase_text3_val'],
                      true,
                      '<span class="highlight label yellow">{_val_}</span>'
                    )?></li>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text4'],
                      $this->i18nView['popup_purchase_text4_val'],
                      true,
                      '<a class="highlight label yellow" href="https://get.adobe.com/reader/" target="_blank">{_val_} <i class="fa fa-external-link"></i></a>'
                    )?></li>
                    <li><?=$this->i18nView['popup_purchase_text5']?></li>
                    <li><?=$this->i18nView['popup_purchase_text6']?></li>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text7'],
                      $this->i18nView['popup_purchase_text7_val'],
                      true,
                      '<span class="highlight label yellow">{_val_}</span>'
                    )?></li>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text8'],
                      $this->i18nView['popup_purchase_text8_val'],
                      false,
                      '<span class="highlight label yellow">{_val_}</span>'
                    )?></li>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text9'],
                      $this->i18nView['popup_purchase_text9_val'],
                      true,
                      '<a class="highlight label green" href="'.\Tbmt\Router::toModule('about', 'faq').'" target="_blank">{_val_} <i class="fa fa-external-link"></i></a>'
                    )?></li>
                    <li><?=\Tbmt\Localizer::insert(
                      $this->i18nView['popup_purchase_text10'],
                      $this->i18nView['popup_purchase_text10_val'],
                      true,
                      '<a class="highlight label blue" href="'.\Tbmt\Router::toModule('about', 'contact').'" target="_blank">{_val_} <i class="fa fa-external-link"></i></a>'
                    )?></li>
                    <li><?=$this->i18nView['popup_purchase_text11']?></li>
                  </ul>

                  <p><?=Tbmt\view\Factory::buildPurchaseAgreements()?></p>

                  <div class="contact-modeal-footer top-20 text-center">
                    <?=Tbmt\view\Factory::buildButtonTag($this->i18nView['popup_purchase_submit'], '', 'shopping-cart', ['id' => 'purchase-confirmation-button'])?>
                    <?=Tbmt\view\Factory::buildButtonTag($this->i18nView['popup_purchase_cancel'], 'black', 'times', ['data-dismiss' => 'modal', 'id' => 'purchase-cancelation-button'])?>
                  </div><!-- // .contact-modeal-footer -->

              </div><!-- // #contact -->
            </div><!-- // #contact-modal -->
          </div><!-- // .modal-content -->
        </div><!-- // .modal-dialog -->
      </div><!-- // .modal -->


      <script src="https://www.paypalobjects.com/api/checkout.js" data-version-4></script>
      <script>
        (function() {

          var CREATE_PAYMENT_URL = '<?php echo $this->createPPPUrl; ?>';
          var EXECUTE_PAYMENT_URL = '<?php echo $this->executePPPUrl; ?>';
          var CANCEL_PAYMENT_URL = '<?php echo $this->cancelPPPUrl; ?>';
          var REDIRECT_SUCCESS_URL = '<?php echo $this->redirectSuccessUrl; ?>';

          var cancelPopup = jQuery('#purchase-cancelation-dialog');
          var confirmPopup = jQuery('#purchase-confirmation-dialog');
          var loadingPopup = jQuery('#purchase-loading-dialog');
          var successPopup = jQuery('#purchase-success-dialog');

          /**
           * [showError description]
           * @param  {[type]} text
           * @return {[type]}
           */
          var showSuccess = function() {
            confirmPopup.modal('hide');
            loadingPopup.modal('hide');
            cancelPopup.modal('hide');
            window.setTimeout(function() {
              successPopup.modal('show');
              window.setTimeout(function() {
                window.location.href = REDIRECT_SUCCESS_URL;
              }, 3000);
            }, 10);
          };

          /**
           * [showError description]
           * @param  {[type]} text
           * @return {[type]}
           */
          var showError = function(text) {
            jQuery('#purchase-cancelation-errorinfo').html(text);
            confirmPopup.modal('hide');
            loadingPopup.modal('hide');
            successPopup.modal('hide');
            window.setTimeout(function() {
              cancelPopup.modal('show');
            }, 10);
          };

          /**
           * [onError description]
           * @param  {[type]} data
           * @return {[type]}
           */
          var onError = function(data, text) {
            showError(text || '');
            if ( text )
              data.errorMessage = text;

            paypal.request.post(CANCEL_PAYMENT_URL, data);
          };

          /**
           *
           */
          var authorizedPayPalData;
          var doConfirm = function() {
            var confirmData = {
              paymentID: authorizedPayPalData.paymentID,
              payerID: authorizedPayPalData.payerID
            };

            paypal.request.post(EXECUTE_PAYMENT_URL, confirmData)
                .then(function(data) {
                  if ( data.error )
                    throw new Error(data.error);

                  showSuccess();
                })
                .catch(function(err) {
                  confirmData.error = err;
                  onError(confirmData, err && err.message || '');
                });

            confirmPopup.modal('hide');
            window.setTimeout(function() {
              loadingPopup.modal('show');
            }, 10);
          };

          var paypalPaymentIdFromCreation = null;

          jQuery('#purchase-confirmation-button').on('click', doConfirm);

          jQuery('#purchase-cancelation-button').on('click', function() {
            onError({paymentID: authorizedPayPalData.paymentID, cause: 'user'});
          });

          paypal.Button.render({

              // env: 'sandbox', // Specify 'sandbox' for the test environment
              // client: {
              //     sandbox: 'AViDHwZfNbaqBZCRRFaPcOdA6ARynGxeaX_cyIX-eCUPWE_W6aF-AQgvr0L1kGsotnNvZeAtp4WWV5qD',
              // },

              payment: function(resolve, reject) {
                  paypalPaymentIdFromCreation = null;

                  var p = paypal.request.post(CREATE_PAYMENT_URL)
                      .then(function(data) {
                        if ( data.error )
                          throw new Error(data.error);

                        if ( !data.paymentID )
                          throw new Error('Result missing paymentID parameter');

                        paypalPaymentIdFromCreation = data.paymentID;
                        resolve(data.paymentID);
                      })
                      .catch(function(err) {
                        reject(err);
                      });
              },

              onAuthorize: function(data, actions) {
                  authorizedPayPalData = data;
                  confirmPopup.modal('show');
              },

              onError: function(error) {
                  onError(null, error.message);
              },

              onCancel: function(data, actions) {
                  data.cause = 'user';
                  if ( !data.paymentID && paypalPaymentIdFromCreation )
                    data.paymentID = paypalPaymentIdFromCreation;

                  onError(data);
              }

          }, '#paypal-button');

        })();
      </script>


    <?php endif; ?>


<?php endif; ?> <!-- close - is logged in -->